# Development overrides: backend hot-reload, frontend Vite HMR.
# Use with: docker compose -f docker-compose.yaml -f docker-compose.dev.yaml up -d
# (Do not use docker-compose.override.yaml so that default "docker compose up" = production)

services:
  backend:
    build:
      context: .
      dockerfile: dockerfiles/dev.Dockerfile
    container_name: smart-interview-backend
    volumes:
      - ./app:/app/app
      - ./asgi.py:/app/asgi.py
      - ./gunicorn.config.py:/app/gunicorn.config.py
      - ./pyproject.toml:/app/pyproject.toml
      - /app/.venv
      - ./uploads:/app/uploads
    environment:
      LOG_LEVEL: debug
      RELOAD: "true"
    command: ["uv", "run", "uvicorn", "asgi:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    develop:
      watch:
        - action: sync
          path: ./app
          target: /app/app
        - action: sync
          path: ./asgi.py
          target: /app/asgi.py
        - action: sync
          path: ./gunicorn.config.py
          target: /app/gunicorn.config.py
        - action: rebuild
          path: ./pyproject.toml

  frontend:
    build:
      context: .
      dockerfile: dockerfiles/dev-frontend.Dockerfile
    container_name: smart-interview-frontend
    restart: unless-stopped
    volumes:
      - ./web:/app
      - /app/node_modules
    ports:
      - "${FRONTEND_PORT:-5173}:5173"
    networks:
      - app_network
    environment:
      - NODE_ENV=development
    develop:
      watch:
        - action: sync
          path: ./web
          target: /app
          ignore:
            - node_modules/
            - dist/
        - action: rebuild
          path: ./web/package.json
        - action: rebuild
          path: ./web/yarn.lock
